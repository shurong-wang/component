<!DOCTYPE html>
<html>

<head>
    <meta charset='utf-8'>
    <title>Bootstrap Tags Input</title>
    <link href='https://cdn.bootcss.com/bootstrap/3.3.7/css/bootstrap.min.css' rel='stylesheet'>
    <link href='https://cdn.bootcss.com/bootstrap-tagsinput/0.8.0/bootstrap-tagsinput.css' rel='stylesheet'>
    <link href='https://cdn.bootcss.com/bootstrap-slider/9.8.1/css/bootstrap-slider.css' rel='stylesheet'>

    <style type='text/css'>
        .bootstrap-tagsinput input {
            display: none;
        }
        .bootstrap-tagsinput {
            background-color: rgba(0, 0, 0, 0);
            border: none;
            box-shadow: none;
            cursor: pointer;
        }
        .bootstrap-tagsinput .tag {
            border: 1px solid #ddd;
            font-size: 16px;
            font-weight: normal;
            color: #333;
            border-radius: 4;
        }
        .bootstrap-tagsinput .label-info {
            background-color: #eee;
        }

        .slider-handle {
            box-shadow: none;
        }
        .slider-handle.custom {
            background: transparent none;
        }
        .slider-handle.custom::before {
            line-height: 20px;
            font-size: 24px;
            content:url('data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAABYAAAARCAYAAADZsVyDAAAABGdBTUEAALGPC/xhBQAAACBjSFJNAAB6JgAAgIQAAPoAAACA6AAAdTAAAOpgAAA6mAAAF3CculE8AAAABmJLR0QAAAAAAAD5Q7t/AAAACXBIWXMAAAsSAAALEgHS3X78AAACf0lEQVQ4y5VUu24TQRQ9d2cfsTa2s1k5VRqqCJoIbZKaIkKIR0WFhKBGikAUfAUFDT8ADRUV4iFIQWuvIytICEVCQnEVx1k58WbNZmdnLkUSK7E3KD7VjO655z5nCGfQbDZNInpKRGtCiDIR/cX/IZjZ0Vr/1lo/C4Kgfmowz7KUUsuO4zyv1Wrz5XIZAMDMF6oahgEpJXZ2dvw4jm80m83G0tISnxPe2NioKaUeua47Pzc3B9M0cVlIKZFl2eMsy34A+AwAxqkxz/N7U1NT933fn0gUADzPg+u6V5n51rAaAAjD8AoRPahWqzXP8yYSBQDLslCpVGDb9moYhncAwAjD0NZaP6lWq6uzs7NjTkop5Hk+vOd5DqVUYdae511j5of1er1qMPOqEOLmzMwMpqenxxy63S7a7TaYGcyMdruNbrdbmHW5XIZlWdeJ6LZhmuYL3/cXL2pBmqaI43goHMcx0jQt5FYqFfi+v2BZ1pphGMbiSaRCshACtm0P77ZtQwhRyDVNE67rgogWDK31ZhzHkFJOPLRR5HmOJEnAzFtGnucvoyja7PV6hWSl1LmgUsrC4QFAv99HFEVbUsrXBhGtK6W+7u/v4/DwsLC80VYU7bmUEieVt5j5E4DjPW40Gt+2t7d5FGma8mAwYK01a615MBhwmqZjvE6nw61W62ej0TjeYwBYXl7+w8zvDg4OuqMtcRwHpVIJRAQiQqlUguM4Y9n2+31kWba+srLycSh8UvKHNE3fR1F07kFcBr1eD0mS/CKiL0O900MQBN16vf42SZK7u7u7E/1uURTh6OjojRBiXBgAhBChUupVp9NZ29vbm+g/Nk3zexAEwyz+Af0ycCycQhqqAAAAAElFTkSuQmCC');
        }
        .slider-tick.custom {
            display: none;
        }
        #Price-slider .slider-selection {
            background: #00aa5f;
        }
    </style>
</head>

<body>

    <div class='container'>
        <div class='row'>
            <div class='col-md-4'>
                <form class='form-horizontal'>
                    <fieldset>
                        <div class=''>
                            <legend class=''>
                                Refline By
                                <a id='clear-all' href='javascript:void(0);' class='pull-right'>Clear all</a>
                            </legend>
                        </div>

                        <section id='Trend' class='control-group filter-section' data-label='Trend'>
                            <label class='control-label row'>
                                <span class='col-md-8'>Trend</span>
                                <a href='javascript:void(0);' class='col-md-4 clear-filter'>Clear</a>
                            </label>

                            <div class='checkbox'>
                                <label>
                                    <input type='checkbox' data-text='Bullish' value='Bullish' checked /> Bullish
                                </label>
                            </div>
                            <div class='checkbox'>
                                <label>
                                    <input type='checkbox' data-text='Bearish' value='Bearish' checked /> Bearish
                                </label>
                            </div>
                            <div class='checkbox'>
                                <label>
                                    <input type='checkbox' data-text='Neutral' value='Neutral'> Neutral
                                </label>
                            </div>
                        </section>

                        <section id='Price' class='control-group filter-section' data-label='Price' style='margin-top: 20px;'>
                            <label class='control-label row'>
                                <span class='col-md-8'>Price</span>
                                <a href='javascript:void(0);' class='col-md-4 clear-filter'>Clear</a>
                            </label>

                            <div class='slider-container' style='padding: 7px 20px;'>
                                <input
                                    id="filter-Price"
                                    type="hidden"
                                    data-provide="slider"
                                    data-slider-id="Price-slider"
                                    data-slider-handle="custom"
                                    data-slider-tooltip="hide"
                                    data-slider-scale="logarithmic"
                                    data-slider-min="0"
                                    data-slider-max="1000"
                                    data-slider-step="1"
                                    data-slider-ticks="[0, 1000]"
                                    ticks_positions="[0, 1000]"
                                    data-slider-value="[30, 960]"
                                    data-slider-ticks-labels='["$30", "$960"]'
                                />
                            </div>
                        </section>

                        <section id='Universe' class='control-group filter-section' data-label='Universe' style='margin-top: 20px;'>
                            <label class='control-label row'>
                                <span class='col-md-8'>Universe</span>
                                <a href='javascript:void(0);' class='col-md-4 clear-filter'>Clear</a>
                            </label>

                            <div class='checkbox'>
                                <label>
                                    <input type='checkbox' data-text='S&P 500' value='S&P 500' checked> S&P 500
                                </label>
                            </div>
                            <div class='checkbox'>
                                <label>
                                    <input type='checkbox' data-text='Russell 1000' value='Russell 1000'> Russell 1000
                                </label>
                            </div>
                        </section>

                    </fieldset>
                </form>
            </div>

            <div class='col-md-8'>
                <div id='tags-wrapper'>
                    <input id='filter-tags' type='hidden' />
                </div>
            </div>
        </div>
    </div>

    <script src='https://cdn.bootcss.com/jquery/2.2.4/jquery.min.js'></script>
    <script src='https://cdn.bootcss.com/bootstrap-tagsinput/0.8.0/bootstrap-tagsinput.min.js'></script>
    <script src='https://cdn.bootcss.com/bootstrap-slider/9.8.1/bootstrap-slider.min.js'></script>

    <script type='text/javascript'>

        // -- mock data start -- //
        const apiData = {
            'filters': {
                'Trend': 'Bullish,Bearish',
                'Price': '30,960',
                'Universe': 'S&P 500'
            }
        };
        const {filters} = apiData;
        // -- mock data end -- //

        // Initialize variable
        let filterSet = new Set([]);
        let preventRemovedCallback = false;
        const $filterSection = $('.filter-section');
        const $priceSlider = $('#filter-Price');
        const $filterTags = $('#filter-tags');
        $filterTags.tagsinput({
            itemValue: 'value',
            itemLabel: 'label',
            itemIndex: 'index'
        });
        const filterHash = [
            'Bullish',
            'Bearish',
            'Neutral',
            'Price',
            'S&P 500',
            'Russell 1000'
        ].reduce((prevHash, currVal, currIndex) => {
            prevHash[currVal] = currIndex;
            return prevHash;
        }, {});

        // Initialize tags and filterSet
        const renderTags = (filters) => {
            for (let label in filters) {
                if (filters.hasOwnProperty(label)) {
                    if ('Price' === label) {
                        const [startVal, endVal] = filters[label].split(',');
                        const tagOpt = {
                            'value': `$${startVal} - $${endVal}`,
                            'label': label,
                            'index': filterHash[label]
                        };
                        $filterTags.tagsinput('add', tagOpt);
                        filterSet.add(JSON.stringify({
                            'value': `${startVal},${endVal}`,
                            'label': label,
                            'index': filterHash[label]
                        }));
                    }
                    else {
                        filters[label].split(',').forEach((value) => {
                            const tagOpt = {
                                'value': value,
                                'label': label,
                                'index': filterHash[value]
                            };
                            $filterTags.tagsinput('add', tagOpt);
                            filterSet.add(JSON.stringify(tagOpt));
                        });
                    }
                }
            }
        };
        renderTags(filters);

        // console.log('filterSet', filterSet);

        const buildParams = () => {
            const queryHash = {};
            for (let item of filterSet.values()) {
                const {
                    value: filterVal,
                    text: filterText,
                    label: filterLabel
                } = JSON.parse(item);
                if (queryHash[filterLabel]) {
                    queryHash[filterLabel] += (`,${filterVal}`);
                }
                else {
                    queryHash[filterLabel] = filterVal;
                }
            }
            return JSON.stringify(queryHash);
        };

        // Request api
        const fetchChart = (data) => {
            const params = buildParams(data);
            console.log(params);

            // var jqxhr = $.get('/api/filter', params)
            // .done(function(resp) {
            //     console.log(resp);
            // })
            // .fail(function(jqXHR, textStatus, errorThrown) {
            //     console.log(textStatus);
            // });

        };

        // Change checkbox
        $filterSection.on('change', 'input:checkbox', function () {
            const $checkbox = $(this);
            const filterLabel = $checkbox.parents('.filter-section').data('label');
            const filterVal = $checkbox.val();
            const isChecked = $checkbox.is(':checked');
            let tagOpt = {
                'value': filterVal,
                'label': filterLabel,
                'index': filterHash[filterVal]
            };
            // Update tags
            preventRemovedCallback = true;
            $filterTags.tagsinput((isChecked ? 'add' : 'remove'), tagOpt);
            preventRemovedCallback = false;
            // Update filterSet
            filterSet[isChecked ? 'add' : 'delete'](JSON.stringify(tagOpt));

            fetchChart(filterSet);
        });

        const onChangePrice = (sliderVal, sliderAct) => {
            const [startVal, endVal] = sliderVal;
            const tagOpt = {
                'value': `$${startVal} - $${endVal}`,
                'label': 'Price',
                'index': filterHash.Price
            };
            const setElem = JSON.stringify({
                'value': `${startVal},${endVal}`,
                'label': 'Price',
                'index': filterHash.Price
            });
            if (sliderAct === 'add') {
                // Update tags
                $filterTags.tagsinput('add', tagOpt);
                // Update filterSet
                filterSet.add(setElem);

                fetchChart(filterSet);
            }
            else {
                // Update tags
                preventRemovedCallback = true;
                $filterTags.tagsinput('remove', tagOpt);
                preventRemovedCallback = false;
                // Update filterSet
                filterSet.delete(setElem);
            }
        };

        const resetPrice = () => {
            const $ticks = $('#Price-slider').find('.slider-tick-label');
            $ticks.eq(0).text(`$0`);
            $ticks.eq(1).text(`$1000`);
            $priceSlider.slider('setValue', [0, 0]);

            filterSet = new Set([...filterSet].filter(elem => !elem.includes('Price')));
        }

        // Change price slider
        $priceSlider.on('change', (slideEvt) => {
            onChangePrice(slideEvt.value.oldValue, 'remove');
        }).on('slide', (slideEvt) => {
            const $ticks = $('#Price-slider').find('.slider-tick-label');
            const [startVal, endVal] = slideEvt.value;
            $ticks.eq(0).text(`$${startVal}`);
            $ticks.eq(1).text(`$${endVal}`);
        }).on('slideStop', (slideEvt) => {
            onChangePrice(slideEvt.value, 'add');
        });

        // Clear
        $('.clear-filter').on('click', function () {
            const $filterSection = $(this).parents('.filter-section');
            const filterLabel = $filterSection.data('label');
            if (filterLabel === 'Price') {
                resetPrice();
            }
            else {
                $filterSection.find('input:checked').prop('checked', false);
            }
            preventRemovedCallback = true;
            const tags = JSON.parse(JSON.stringify($filterTags.tagsinput('items')));
            tags.forEach(tag => {
                if (tag.label === filterLabel) {
                    $filterTags.tagsinput('remove', tag);
                }
            });
            preventRemovedCallback = false;
            filterSet = new Set([...filterSet].filter(elem => !elem.includes(filterLabel)));

            fetchChart(filterSet);
        });

        // Clear all
        $('#clear-all').on('click', function () {
            $filterSection.find('input:checked').prop('checked', false);
            resetPrice();
            $filterTags.tagsinput('removeAll');
            filterSet.clear();

            fetchChart(filterSet);
        });

        // Close tag
        $filterTags.on('itemRemoved', function (event) {
            // console.log(preventRemovedCallback, event.item);
            if (preventRemovedCallback) {
                return;
            }
            if (event.item) {
                const {label, value} = event.item;
                if ('Price' === label) {
                    // Update slider
                    resetPrice();
                }
                else {
                    // Update checkbox
                    $(`#${label}`).find(`:checkbox[value='${value}']`).prop('checked', false);
                }
                // Update filterSet
                filterSet.delete(JSON.stringify(event.item));

                fetchChart(filterSet);
            }
        });

        // Sort tag
        $filterTags.on('itemAdded', function (event) {
            const newTag = event.item;
            const {value, label, index} = newTag;
            const tags = JSON.parse(JSON.stringify($filterTags.tagsinput('items')));
            const insertIndex = tags.findIndex(tag => tag.index > newTag.index);
            if (insertIndex > -1) {
                const newTags = [...tags.slice(0, insertIndex), newTag, ...tags.slice(insertIndex)];
                $filterTags.tagsinput('removeAll');
                newTags.forEach(tag => {
                    $filterTags.tagsinput('add', tag);
                });
            }
        });

    </script>

</body>

</html>
